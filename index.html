<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Penjualan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom styles for better UX */
        body { font-family: 'Inter', sans-serif; }
        .nav-link {
            transition: all 0.3s ease;
        }
        .nav-link.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        .nav-link:hover:not(.active) {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Container -->
    <div id="app" class="flex h-screen bg-gray-200">

        <!-- Login Page -->
        <div id="login-page" class="w-full h-full flex items-center justify-center bg-gray-800">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-center text-gray-800">Selamat Datang</h2>
                <p class="text-center text-gray-600">Silakan login untuk melanjutkan</p>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="text-sm font-semibold text-gray-700 block">Email</label>
                        <input type="email" id="email" name="email" class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="nama@email.com" required>
                    </div>
                    <div>
                        <label for="password" class="text-sm font-semibold text-gray-700 block">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" required>
                    </div>
                    <div>
                        <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Login</button>
                    </div>
                </form>
                <div id="login-error" class="text-sm text-center text-red-500"></div>
                <p class="text-xs text-center text-gray-500">
                    Belum punya akun? <a href="#" id="show-register" class="text-blue-600 hover:underline">Daftar di sini</a>.
                </p>
            </div>
        </div>

         <!-- Register Page -->
        <div id="register-page" class="w-full h-full flex items-center justify-center bg-gray-800 hidden">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-center text-gray-800">Buat Akun Baru</h2>
                <form id="register-form" class="space-y-6">
                    <div>
                        <label for="register-email" class="text-sm font-semibold text-gray-700 block">Email</label>
                        <input type="email" id="register-email" class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="nama@email.com" required>
                    </div>
                    <div>
                        <label for="register-password" class="text-sm font-semibold text-gray-700 block">Password</label>
                        <input type="password" id="register-password" class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Minimal 6 karakter" required>
                    </div>
                    <div>
                        <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Daftar</button>
                    </div>
                </form>
                <div id="register-error" class="text-sm text-center text-red-500"></div>
                <p class="text-xs text-center text-gray-500">
                    Sudah punya akun? <a href="#" id="show-login" class="text-blue-600 hover:underline">Login di sini</a>.
                </p>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-app" class="hidden w-full h-full">
            <!-- Sidebar -->
            <div id="sidebar" class="flex flex-col w-64 bg-white shadow-lg">
                <div class="flex items-center justify-center h-20 border-b">
                    <h1 class="text-2xl font-bold text-blue-600">SalesApp</h1>
                </div>
                <nav class="flex-grow px-4 py-4">
                    <a href="#" id="nav-form" class="nav-link flex items-center p-3 my-2 rounded-lg">
                        <i class="fas fa-edit w-6 text-center"></i><span class="ml-4">Form Penjualan</span>
                    </a>
                    <a href="#" id="nav-dashboard" class="nav-link admin-only flex items-center p-3 my-2 rounded-lg">
                        <i class="fas fa-chart-line w-6 text-center"></i><span class="ml-4">Dasbor & CRUD</span>
                    </a>
                     <a href="#" id="nav-products" class="nav-link admin-only flex items-center p-3 my-2 rounded-lg">
                        <i class="fas fa-box w-6 text-center"></i><span class="ml-4">Manajemen Produk</span>
                    </a>
                    <a href="#" id="nav-users" class="nav-link admin-only flex items-center p-3 my-2 rounded-lg">
                        <i class="fas fa-users-cog w-6 text-center"></i><span class="ml-4">Manajemen User</span>
                    </a>
                </nav>
                <div class="px-4 py-4 border-t">
                    <div id="user-profile" class="flex items-center">
                        <i class="fas fa-user-circle text-2xl text-gray-500"></i>
                        <div class="ml-3">
                            <p id="user-email" class="text-sm font-semibold text-gray-700"></p>
                            <p id="user-role" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <button id="logout-button" class="w-full mt-4 px-4 py-2 text-sm font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    <!-- Page: Sales Form -->
                    <div id="page-form" class="hidden">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Form Input Penjualan</h2>
                        <form id="sales-form" class="bg-white p-8 rounded-lg shadow-md">
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700">ID Penjualan</label>
                                    <input type="text" id="id_penjualan" class="w-full mt-1 p-2 bg-gray-200 border rounded" readonly>
                                    <small class="text-gray-500">ID akan dibuat secara otomatis.</small>
                                </div>
                                <div>
                                    <label class="block text-gray-700">Nama Sales</label>
                                    <input type="text" id="nama_sales" class="w-full mt-1 p-2 border rounded" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700">Nama Pelanggan</label>
                                    <input type="text" id="nama_pelanggan" class="w-full mt-1 p-2 border rounded" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700">Nomor Telepon Pelanggan</label>
                                    <input type="tel" id="telepon_pelanggan" class="w-full mt-1 p-2 border rounded" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-gray-700">Alamat Pelanggan</label>
                                    <textarea id="alamat_pelanggan" rows="2" class="w-full mt-1 p-2 border rounded" required></textarea>
                                </div>
                                <div>
                                    <label class="block text-gray-700">Tanggal Pembelian</label>
                                    <input type="date" id="tanggal_pembelian" class="w-full mt-1 p-2 border rounded" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700">Estimasi Tanggal Pengiriman</label>
                                    <input type="date" id="tanggal_pengiriman" class="w-full mt-1 p-2 border rounded" required>
                                </div>
                           </div>
                           <div class="mt-8 border-t pt-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold text-gray-700">Detail Produk</h3>
                                    <button type="button" id="add-product-btn" class="px-4 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600"><i class="fas fa-plus mr-2"></i>Tambah Produk</button>
                                </div>
                                <div id="product-list" class="space-y-4">
                                </div>
                           </div>
                           <div class="mt-8 border-t pt-6 text-right">
                                <h3 class="text-2xl font-bold">Total Keseluruhan: <span id="grand-total">Rp 0</span></h3>
                           </div>
                           <div class="mt-8 text-right">
                               <button type="submit" class="px-8 py-3 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Simpan Penjualan</button>
                           </div>
                        </form>
                    </div>

                    <!-- Page: Dashboard -->
                    <div id="page-dashboard" class="hidden">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Dasbor Performa & Data Penjualan</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                           <div class="bg-white p-6 rounded-lg shadow flex items-center justify-between">
                               <div>
                                   <p class="text-sm font-medium text-gray-500">Total Penjualan</p>
                                   <p id="stat-total-penjualan" class="text-3xl font-bold text-gray-800">Rp 0</p>
                               </div>
                               <div class="w-12 h-12 flex items-center justify-center bg-blue-100 rounded-full">
                                   <i class="fas fa-dollar-sign text-2xl text-blue-500"></i>
                               </div>
                           </div>
                           <div class="bg-white p-6 rounded-lg shadow flex items-center justify-between">
                               <div>
                                   <p class="text-sm font-medium text-gray-500">Jumlah Transaksi</p>
                                   <p id="stat-jumlah-transaksi" class="text-3xl font-bold text-gray-800">0</p>
                               </div>
                               <div class="w-12 h-12 flex items-center justify-center bg-green-100 rounded-full">
                                   <i class="fas fa-receipt text-2xl text-green-500"></i>
                               </div>
                           </div>
                           <div class="bg-white p-6 rounded-lg shadow flex items-center justify-between">
                               <div>
                                   <p class="text-sm font-medium text-gray-500">Produk Terjual</p>
                                   <p id="stat-produk-terjual" class="text-3xl font-bold text-gray-800">0</p>
                               </div>
                               <div class="w-12 h-12 flex items-center justify-center bg-yellow-100 rounded-full">
                                   <i class="fas fa-box-open text-2xl text-yellow-500"></i>
                               </div>
                           </div>
                           <div class="bg-white p-6 rounded-lg shadow flex items-center justify-between">
                               <div>
                                   <p class="text-sm font-medium text-gray-500">Jumlah Pelanggan</p>
                                   <p id="stat-jumlah-pelanggan" class="text-3xl font-bold text-gray-800">0</p>
                               </div>
                               <div class="w-12 h-12 flex items-center justify-center bg-purple-100 rounded-full">
                                   <i class="fas fa-users text-2xl text-purple-500"></i>
                               </div>
                           </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-4">
                               <h3 class="text-xl font-semibold">Semua Data Penjualan</h3>
                               <div class="space-x-2">
                                   <button id="export-excel-btn" class="px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700"><i class="fas fa-file-excel mr-2"></i>Ekspor Excel</button>
                                   <button id="export-pdf-btn" class="px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700"><i class="fas fa-file-pdf mr-2"></i>Ekspor PDF</button>
                               </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">ID Penjualan</th>
                                            <th scope="col" class="px-6 py-3">Pelanggan</th>
                                            <th scope="col" class="px-6 py-3">Tanggal</th>
                                            <th scope="col" class="px-6 py-3">Sales</th>
                                            <th scope="col" class="px-6 py-3">Total Harga</th>
                                            <th scope="col" class="px-6 py-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sales-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Product Management -->
                    <div id="page-products" class="hidden">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manajemen Produk</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1">
                                <form id="product-form" class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 id="product-form-title" class="text-xl font-semibold mb-4">Tambah Produk Baru</h3>
                                    <input type="hidden" id="product-id">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-gray-700">Nama Produk</label>
                                            <input type="text" id="product-name" class="w-full mt-1 p-2 border rounded" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700">Harga</label>
                                            <input type="number" id="product-price" class="w-full mt-1 p-2 border rounded" required>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Simpan</button>
                                            <button type="button" id="cancel-edit-product-btn" class="w-full px-4 py-2 font-bold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 hidden">Batal</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                               <h3 class="text-xl font-semibold mb-4">Daftar Produk</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left text-gray-500">
                                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3">Nama Produk</th>
                                                <th scope="col" class="px-6 py-3">Harga</th>
                                                <th scope="col" class="px-6 py-3">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="products-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Page: User Management -->
                    <div id="page-users" class="hidden">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manajemen Pengguna</h2>
                        <div class="bg-white p-6 rounded-lg shadow">
                             <div class="flex justify-between items-center mb-4">
                               <h3 class="text-xl font-semibold">Daftar Pengguna</h3>
                               <button id="add-user-btn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700"><i class="fas fa-plus mr-2"></i>Tambah User</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Email</th>
                                            <th scope="col" class="px-6 py-3">User ID</th>
                                            <th scope="col" class="px-6 py-3">Peran Saat Ini</th>
                                            <th scope="col" class="px-6 py-3">Ubah Peran</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Modal for Add User -->
        <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/3">
                 <form id="add-user-form" class="p-6">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-2xl font-semibold">Tambah User Baru</h3>
                        <button type="button" id="close-add-user-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div class="space-y-4">
                         <div>
                            <label class="block text-gray-700">Email</label>
                            <input type="email" id="new-user-email" class="w-full mt-1 p-2 border rounded" required>
                        </div>
                         <div>
                            <label class="block text-gray-700">Password</label>
                            <input type="password" id="new-user-password" class="w-full mt-1 p-2 border rounded" required>
                        </div>
                         <div>
                            <label class="block text-gray-700">Peran</label>
                            <select id="new-user-role" class="w-full mt-1 p-2 border rounded">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div id="add-user-error" class="text-sm text-red-500"></div>
                        <div class="text-right">
                             <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan User</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal for Edit/View Sales -->
        <div id="sales-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-1/2 max-h-screen overflow-y-auto no-scrollbar">
                <div class="p-6">
                    <div class="flex justify-between items-center border-b pb-3">
                        <h3 class="text-2xl font-semibold">Detail Penjualan</h3>
                        <div class="space-x-2">
                             <button id="print-invoice-modal-btn" class="px-4 py-2 text-sm bg-teal-500 text-white rounded hover:bg-teal-600"><i class="fas fa-print mr-2"></i>Cetak Invoice</button>
                             <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        </div>
                    </div>
                    <div id="modal-content" class="mt-4">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-500"></div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, where, getDocs, deleteDoc, updateDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // IMPORTANT: Replace with your Firebase project's configuration
       const firebaseConfig = {
  apiKey: "AIzaSyB3tTddbg09dEoW1RVVPxG5OrhAScj0x6M",
  authDomain: "sales-6fbe3.firebaseapp.com",
  projectId: "sales-6fbe3",
  storageBucket: "sales-6fbe3.firebasestorage.app",
  messagingSenderId: "829636684860",
  appId: "1:829636684860:web:3302dea7d7fe548d742739"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // --- GLOBAL STATE ---
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const mainApp = document.getElementById('main-app');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        let currentUserRole = null;
        let salesUnsubscribe = null;
        let usersUnsubscribe = null;
        let productsUnsubscribe = null;
        let currentOpenSaleId = null;
        let productMasterList = [];

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loadingSpinner.classList.remove('hidden');
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    currentUserRole = userDoc.data().role;
                } else {
                    await setDoc(userDocRef, { email: user.email, role: 'user' });
                    currentUserRole = 'user';
                }
                
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-role').textContent = `Peran: ${currentUserRole}`;
                setupUIForRole(currentUserRole);
                navigateTo('form');
                
                loginPage.classList.add('hidden');
                registerPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                mainApp.classList.add('flex');

                attachListeners(); 
                loadingSpinner.classList.add('hidden');
            } else {
                currentUserRole = null;
                mainApp.classList.add('hidden');
                mainApp.classList.remove('flex');
                loginPage.classList.remove('hidden');
                if (salesUnsubscribe) salesUnsubscribe();
                if (usersUnsubscribe) usersUnsubscribe();
                if (productsUnsubscribe) productsUnsubscribe();
            }
        });

        // --- Login/Register Forms ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value)
                .catch(err => document.getElementById('login-error').textContent = `Error: ${err.message}`);
        });

        document.getElementById('register-form').addEventListener('submit', e => {
            e.preventDefault();
            createUserWithEmailAndPassword(auth, document.getElementById('register-email').value, document.getElementById('register-password').value)
                .catch(error => document.getElementById('register-error').textContent = `Gagal mendaftar: ${error.message}`);
        });

        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        document.getElementById('show-register').addEventListener('click', e => { e.preventDefault(); loginPage.classList.add('hidden'); registerPage.classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', e => { e.preventDefault(); registerPage.classList.add('hidden'); loginPage.classList.remove('hidden'); });

        // --- UI & NAVIGATION ---
        function setupUIForRole(role) {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = (role === 'admin' ? 'flex' : 'none'));
        }
        
        const pages = { form: document.getElementById('page-form'), dashboard: document.getElementById('page-dashboard'), users: document.getElementById('page-users'), products: document.getElementById('page-products') };
        const navLinks = { form: document.getElementById('nav-form'), dashboard: document.getElementById('nav-dashboard'), users: document.getElementById('nav-users'), products: document.getElementById('nav-products') };
        
        function navigateTo(pageKey) {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            Object.values(navLinks).forEach(link => link.classList.remove('active'));
            if (pages[pageKey]) pages[pageKey].classList.remove('hidden');
            if (navLinks[pageKey]) navLinks[pageKey].classList.add('active');
            if (pageKey === 'form') generateSalesID();
        }
        
        Object.keys(navLinks).forEach(key => navLinks[key].addEventListener('click', (e) => { e.preventDefault(); navigateTo(key); }));

        // --- PRODUCT DROPDOWN LOGIC ---
        function populateProductDropdown(selectElement) {
            selectElement.innerHTML = '<option value="">Pilih Produk...</option>';
            productMasterList.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.textContent = product.name;
                option.dataset.price = product.price;
                selectElement.appendChild(option);
            });
        }

        // --- SALES FORM LOGIC ---
        const productList = document.getElementById('product-list');
        let productCount = 0;

        function addProductItem() {
            if (productCount >= 5) { alert("Maksimal 5 produk per transaksi."); return; }
            productCount++;
            const productItem = document.createElement('div');
            productItem.className = 'grid grid-cols-1 md:grid-cols-12 gap-2 items-center border p-2 rounded';
            productItem.innerHTML = `
                <div class="md:col-span-4">
                    <label class="text-xs">Nama Produk</label>
                    <select class="product-name w-full p-1.5 border rounded" required></select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs">Qty</label>
                    <input type="number" class="product-qty w-full p-1 border rounded" value="1" min="1" required>
                </div>
                <div class="md:col-span-3">
                    <label class="text-xs">Harga Produk</label>
                    <input type="number" class="product-price w-full p-1 border rounded" value="0" min="0" required>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs">Total</label>
                    <input type="text" class="product-total w-full p-1 bg-gray-200 border rounded" readonly>
                </div>
                <div class="text-right">
                    <button type="button" class="remove-product-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                </div>
            `;
            productList.appendChild(productItem);
            const newSelect = productItem.querySelector('.product-name');
            populateProductDropdown(newSelect);
        }

        productList.addEventListener('change', e => {
            if (e.target.classList.contains('product-name')) {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const price = selectedOption.dataset.price || 0;
                const item = e.target.closest('.grid');
                item.querySelector('.product-price').value = price;
                calculateRowTotal(item);
            }
        });
        
        productList.addEventListener('input', e => {
             if (e.target.classList.contains('product-qty') || e.target.classList.contains('product-price')) {
                const item = e.target.closest('.grid');
                calculateRowTotal(item);
            }
        });

        function calculateRowTotal(item) {
             const qty = parseFloat(item.querySelector('.product-qty').value) || 0;
             const price = parseFloat(item.querySelector('.product-price').value) || 0;
             const total = qty * price;
             item.querySelector('.product-total').value = formatCurrency(total);
             updateGrandTotal();
        }

        productList.addEventListener('click', e => {
            if (e.target.closest('.remove-product-btn')) {
                e.target.closest('.grid').remove();
                productCount--;
                updateGrandTotal();
            }
        });
        
        function formatCurrency(value) {
            return `Rp ${(value || 0).toLocaleString('id-ID')}`;
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('#product-list .grid').forEach(item => {
                const totalText = item.querySelector('.product-total').value.replace(/[^0-9]/g, '');
                grandTotal += parseFloat(totalText) || 0;
            });
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
        }
        
        document.getElementById('add-product-btn').addEventListener('click', addProductItem);
        async function generateSalesID() {
            const now = new Date();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            const q = query(collection(db, "sales"), where("year", "==", year), where("month", "==", parseInt(month)), orderBy("sequence", "desc"), limit(1));
            const querySnapshot = await getDocs(q);
            let nextSequence = querySnapshot.empty ? 1 : querySnapshot.docs[0].data().sequence + 1;
            document.getElementById('id_penjualan').value = `UO/${nextSequence.toString().padStart(3, '0')}/${month}/${year}/RA`;
            document.getElementById('tanggal_pembelian').valueAsDate = now;
            const deliveryDate = new Date();
            deliveryDate.setDate(now.getDate() + 3);
            document.getElementById('tanggal_pengiriman').valueAsDate = deliveryDate;
        }

        // --- FIRESTORE & DATA HANDLING ---
        document.getElementById('sales-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');

            const idPenjualan = document.getElementById('id_penjualan').value;
            const parts = idPenjualan.split('/');
            const salesData = {
                idPenjualan,
                sequence: parseInt(parts[1]) || 0,
                year: parseInt(parts[3]) || 0,
                month: parseInt(parts[2]) || 0,
                namaPelanggan: document.getElementById('nama_pelanggan').value,
                alamatPelanggan: document.getElementById('alamat_pelanggan').value,
                teleponPelanggan: document.getElementById('telepon_pelanggan').value,
                tanggalPembelian: document.getElementById('tanggal_pembelian').value,
                tanggalPengiriman: document.getElementById('tanggal_pengiriman').value,
                namaSales: document.getElementById('nama_sales').value,
                products: [],
                grandTotal: 0,
                createdBy: auth.currentUser.uid,
                createdAt: serverTimestamp()
            };

            document.querySelectorAll('#product-list .grid').forEach(item => {
                const name = item.querySelector('.product-name').value;
                if (name) {
                    const qty = parseFloat(item.querySelector('.product-qty').value) || 0;
                    const price = parseFloat(item.querySelector('.product-price').value) || 0;
                    const total = qty * price;
                    salesData.products.push({ name, qty, price, total });
                    salesData.grandTotal += total;
                }
            });

            if (salesData.products.length === 0) {
                alert('Harap tambahkan minimal satu produk.');
                loadingSpinner.classList.add('hidden');
                return;
            }

            try {
                const docRef = await addDoc(collection(db, "sales"), salesData);
                const sendSaleNotification = httpsCallable(functions, 'sendSaleNotification');
                await sendSaleNotification({ saleId: docRef.id, saleData });
                alert('Data penjualan berhasil disimpan!');
                e.target.reset();
                productList.innerHTML = '';
                productCount = 0;
                updateGrandTotal();
                generateSalesID();
                addProductItem();
            } catch (error) {
                alert(`Gagal menyimpan data: ${error.message}`);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });
        
        function attachListeners() {
            // Product listener for all users
            productsUnsubscribe = onSnapshot(query(collection(db, "products"), orderBy("name")), (snapshot) => {
                productMasterList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentUserRole === 'admin') {
                    renderProductsTable(productMasterList);
                }
            });

            if (currentUserRole === 'admin') {
                salesUnsubscribe = onSnapshot(query(collection(db, "sales"), orderBy("createdAt", "desc")), (snapshot) => {
                    const sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSalesTable(sales);
                    updateDashboardStats(sales);
                });

                usersUnsubscribe = onSnapshot(query(collection(db, "users")), (snapshot) => {
                    const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsersTable(users);
                });
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderSalesTable(sales) { /* Unchanged */ }
        function updateDashboardStats(sales) { /* Unchanged */ }
        function renderUsersTable(users) { /* Unchanged */ }

        // --- PRODUCT MANAGEMENT ---
        const productForm = document.getElementById('product-form');
        const productFormTitle = document.getElementById('product-form-title');
        const productsTableBody = document.getElementById('products-table-body');
        const cancelEditBtn = document.getElementById('cancel-edit-product-btn');

        productForm.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);

            if (!name || isNaN(price)) {
                alert('Nama dan harga produk harus diisi.');
                return;
            }
            
            loadingSpinner.classList.remove('hidden');
            try {
                if (id) {
                    // Update
                    await updateDoc(doc(db, "products", id), { name, price });
                } else {
                    // Add
                    await addDoc(collection(db, "products"), { name, price });
                }
                resetProductForm();
            } catch (error) {
                alert(`Gagal menyimpan produk: ${error.message}`);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        function renderProductsTable(products) {
            productsTableBody.innerHTML = '';
            products.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                    <td class="px-6 py-4">${formatCurrency(p.price)}</td>
                    <td class="px-6 py-4 space-x-2">
                        <button class="edit-product-btn text-yellow-600 hover:underline" data-id="${p.id}">Edit</button>
                        <button class="delete-product-btn text-red-600 hover:underline" data-id="${p.id}">Hapus</button>
                    </td>
                `;
                productsTableBody.appendChild(row);
            });
        }
        
        productsTableBody.addEventListener('click', async e => {
            const target = e.target;
            const id = target.dataset.id;
            if (target.classList.contains('delete-product-btn')) {
                if (confirm('Anda yakin ingin menghapus produk ini?')) {
                    await deleteDoc(doc(db, "products", id));
                }
            }
            if (target.classList.contains('edit-product-btn')) {
                const product = productMasterList.find(p => p.id === id);
                if (product) {
                    productFormTitle.textContent = 'Edit Produk';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-price').value = product.price;
                    cancelEditBtn.classList.remove('hidden');
                }
            }
        });

        function resetProductForm() {
            productForm.reset();
            productFormTitle.textContent = 'Tambah Produk Baru';
            document.getElementById('product-id').value = '';
            cancelEditBtn.classList.add('hidden');
        }
        cancelEditBtn.addEventListener('click', resetProductForm);

        // --- USER MANAGEMENT MODAL ---
        const addUserModal = document.getElementById('add-user-modal');
        document.getElementById('add-user-btn').addEventListener('click', () => addUserModal.classList.remove('hidden'));
        document.getElementById('close-add-user-modal-btn').addEventListener('click', () => addUserModal.classList.add('hidden'));

        document.getElementById('add-user-form').addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            const errorDiv = document.getElementById('add-user-error');
            errorDiv.textContent = '';
            loadingSpinner.classList.remove('hidden');

            try {
                // Call Cloud Function to create user
                const createNewUser = httpsCallable(functions, 'createNewUser');
                const result = await createNewUser({ email, password, role });
                if (result.data.success) {
                    alert('User berhasil dibuat!');
                    addUserModal.classList.add('hidden');
                    e.target.reset();
                } else {
                    throw new Error(result.data.error);
                }
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });


        // --- Other Functions (CRUD, Modal, Print, Export) ---
        // (These functions remain largely unchanged from the previous version)
        // [ Placeholder for renderSalesTable, updateDashboardStats, renderUsersTable, displaySalesModal, handleUpdateSale, closeModal, printInvoice, and export functions ]

    </script>

    <!-- 
    ==================================================================
    PENTING: PERBARUI CLOUD FUNCTION ANDA
    ==================================================================
    Anda perlu MENAMBAHKAN fungsi `createNewUser` di bawah ini ke file
    `functions/index.js` Anda dan men-deploy ulang.
    
    1. Buka file `index.js` di dalam folder `functions` proyek Firebase Anda.
    2. Anda akan memerlukan Firebase Admin SDK. Jalankan `npm install firebase-admin` di dalam folder `functions` jika belum ada.
    3. Tambahkan kode `createNewUser` di bawah fungsi `sendSaleNotification` yang sudah ada.
    
    -------------------- KODE TAMBAHAN UNTUK functions/index.js --------------------
    
    const admin = require("firebase-admin");
    admin.initializeApp();
    
    // ... (fungsi sendSaleNotification Anda yang sudah ada di sini) ...

    exports.createNewUser = functions.https.onCall(async (data, context) => {
        // Pastikan pemanggil adalah admin
        if (context.auth.token.role !== 'admin') {
            throw new functions.https.HttpsError(
                'permission-denied', 
                'Hanya admin yang dapat membuat user baru.'
            );
        }

        const { email, password, role } = data;

        try {
            // Buat user di Firebase Authentication
            const userRecord = await admin.auth().createUser({
                email: email,
                password: password,
                emailVerified: false, // Anda bisa set true jika ingin verifikasi
            });

            // Set custom claim untuk role
            await admin.auth().setCustomUserClaims(userRecord.uid, { role: role });
            
            // Buat dokumen user di Firestore
            await admin.firestore().collection('users').doc(userRecord.uid).set({
                email: email,
                role: role,
            });

            return { success: true, uid: userRecord.uid };

        } catch (error) {
            // Tangani error, misal email sudah ada
            throw new functions.https.HttpsError('unknown', error.message, error);
        }
    });

    -------------------- AKHIR DARI KODE CLOUD FUNCTION --------------------
    -->
    
</body>
</html>
